<!DOCTYPE html>
<html class="no-js">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Editor</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">

	<link rel="stylesheet" href="css/editor.css">
	<link rel="stylesheet" href="css/ui-lightness-jquery-ui-1.8.7.custom.css">

</head>
<style>

	.clip {
		width: 300px; height: 300px;
  		background: #222;
  		clip-path: url(#myClip);	
	}
	
</style>

<body>
	<div class="clip">
	<svg width="0" height="0">
		<defs>
			<clipPath id="myClip">
		
			<path stroke="#000000" d="M607.2,331.8 l12.6,-0.7 0.1,-4.1 h4.3 l30.4,-3.2 45.1,-4.3 5.6,-3.6 3.9,-2.1 0.1,-1.9 6,-7.8 4.1,-3.6 2.1,-2.4 -3.3,-2 -2.5,-2.7 -3,-3.8 -0.5,-2.2 -2.6,-1.4 -0.9,-1.9 -0.2,-6.1 -2.6,-2 -1.9,-1.1 -0.5,-2.3 -1.3,0.2 -2,1.2 -2.5,2.7 -1.9,-1.7 -2.5,-0.5 -2.4,1.4 h-2.3 l-1.8,-2 -5.6,-0.1 -1.8,-4.5 -2.9,-1.5 -2.1,0.8 -4.2,0.2 -0.5,2.1 1.2,1.5 0.3,2.1 -2.8,2 -3.8,1.8 -2.6,0.4 -0.5,4.5 -4.9,3.6 -2.6,3.7 0.2,2.2 -0.9,2.3 -4.5,-0.1 -1.3,-1.3 -3.9,2.2 0.2,3.3 -2.4,0.6 -0.8,-1.4 -1.7,-1.2 -2.7,1.1 -1.8,3.5 -2.2,-1 -1.4,-1.6 -3.7,0.4 -5.6,1 -2.8,1.3 -1.2,3.4 -1,1 1.5,3.7 -4.2,1.4 -1.9,1.4 -0.4,2.2 1.2,2.4 v2.2 l-1.6,0.4 -6.1,-2.5 -2.3,0.9 -2,1.4 -0.8,1.8 1.7,2.4 -0.9,1.8 -0.1,3.3 -2.4,1.3 -2.1,1.7z" />

			</clipPath>	
			
		</defs>
	</svg>
	</div>
		
	<!--<img clip-path="url(#myClip)" src="img/ota_badge.jpg" style="height: 150px">-->
	
	<p id="statePath"></p>

	<div id="imageEditor">
		<section id="editorContainer">
			<canvas id="editor" width="480" height="480" style="border:1px solid #000000"></canvas>
		</section>
	</div>

	<input type="file" id="UploadImage" href="#" title="Upload Your Image">Upload Image</input>
	<button type="button" onclick="testPath()">Test Path</button>

	<script src="jquery/jquery-1.12.4.min.js"></script>
	<script src="jquery/jquery-ui-1.10.3.js"></script>
	<script src="js/raphael.js"></script>
	<script src="js/usa_map.js"></script>
	<script src="js/Fabric_JS/fabric.min.js"></script>


	<script>
		//Changing the control colors from light blue to black
		fabric.Object.prototype.set({
			transparentCorners: true,
			borderColor: '#111111',
			cornerColor: '#111111'
		});

		//get information about the state that the user clicked on the main map page
		var stateNameStored = localStorage.getItem('storedStateName');
		var idNameStored = localStorage.getItem('storedIdName');

		// changing the editor background color
		var canvas = new fabric.Canvas('editor', {
			backgroundColor: 'whitesmoke'
		});

		// const flyArrowPath = 'M,361.1,70.77,l,-5.3,57.13,l,-1.3,15.2,l,-59.1,-6.6,l,-49,-7.1,l,-1.4,11.2,l,-1.9,-1.7,l,-0.4,-2.5,l,-1.3,-1.9,l,-3.3,1.5,l,-0.7,2.5,l,-2.3,0.3,l,-3.8,-1.6,l,-4.1,0.1,l,-2.4,0.7,l,-3.2,-1.5,l,-3,0.2,l,-2.1,1.9,l,-0.9,-0.6,l,-0.7,-3.4,l,0.7,-3.2,l,-2.7,-3.2,l,-3.3,-2.5,l,-2.5,-12.6,l,-0.1,-5.3,l,-1.6,-0.8,l,-0.6,1,l,-4.5,3.2,l,-1.2,-0.1,l,-2.3,-2.8,l,-0.2,-2.8,l,7,-17.15,l,-0.6,-2.67,l,-3.5,-1.12,l,-0.4,-0.91,l,-2.7,-3.5,l,-4.6,-10.41,l,-3.2,-1.58,l,-1.8,-4.26,l,1.3,-4.63,l,-3.2,-7.57,l,4.4,-21.29,l,32.7,6.89,l,18.4,3.4,l,32.3,5.3,l,29.3,4,l,29.2,3.5,l,30.8,3.07,z';


	// const arrowPlane = new fabric.Path(flyArrowPath);


		// loading the background/overlay image from SVG of the state that was cicked
		var statePath;
		var statePathObj;
		var groupStates = [];
		var overlayState;
		fabric.loadSVGFromURL("svg/usa_map.svg", function(objects, options) {
				var stateObjects = new fabric.Group(groupStates);
				stateObjects.set({
					left: 10,
					top: 10,
					width: canvas.width - 10,
					height: canvas.height - 10
				});

				for (var i = 0; i < objects.length; i++) {
					if (stateObjects._objects[i].id == idNameStored) {
						overlayState = stateObjects._objects[i];

						overlayState.set({
							// opacity: .4,
							left: 0,
							top: 0,
							stroke: 'black',
							strokeWidth: 2,
							fill: 'transparent',
							// height: canvas.height,
							// width: canvas.width
							height: 250,
							width: 300, // Changed the size of the state so that it fits better in the canvas. This ties with the scaling X and Y
							selectable: false,
							scaleX: 1.5,
							scaleY: 1.5 // Increasing the size of the state image so it is easier for the user to fit their image into the shape of the state.\
						})


						canvas.add(overlayState);
						canvas.setOverlayImage(overlayState);
						canvas.controlsAboveOverlay = true;

						// statePath = String(stateObjects._objects[i].path); // hoping this will work for clip-path... but it doesnt.
						// statePathObj = new fabric.Path(statePath);
						// statePathObj.set({
						// 	fill: 'red',
						// 	left: 10,
						// 	top: 10,
						// 	width: canvas.width - 10,
						// 	height: canvas.height - 10
						// });
						//canvas.add(statePathObj); // This works but is unnecessary since we cant use variables in the clip path


					}
				}
			},
			function(item, object) {
				object.set('id', item.getAttribute('id'));
				groupStates.push(object);
			});


		// // uploading user image
		// var userImage = new fabric.Image();
		// document.getElementById('UploadImage').onchange = function handleImage(e) {
		//
		// 			var reader = new FileReader();
		// 			reader.onload = function(event) {
		//
		// 				var imgObj = new Image();
		// 				imgObj.src = event.target.result;
		// 				imgObj.onload = function() {
		//
		// 					userImage = new fabric.Image(imgObj);
		// 					userImage.set({
		// 						left: 10,
		// 						top: 10,
		// 						width: canvas.width - 10,
		// 						height: canvas.height - 10,
		// 						opacity: 1,
		// 						clipTo: function (ctx) {
		// 							overlayState.set ({
		// 								// left: 10,
		// 								// top: 10,
		// 								// width: canvas.width - 10,
		// 								// height: canvas.height - 10
		// 							});
		// 						 overlayState.render(ctx);
		// 					 }
		// 					});
		// 					canvas.add(userImage);
		// 					userImage.globalCompositeOperation = 'source-atop';
		// 					canvas.renderAll();
		// 				}
		// 			}
		// 			reader.readAsDataURL(e.target.files[0]);
		// 	}


		// uploading user image2
		var userImage = new fabric.Image();
		document.getElementById('UploadImage').onchange = function handleImage(e) {

			var reader = new FileReader();
			reader.onload = function(event) {

				var imgObj = new Image();
				imgObj.src = event.target.result;
				imgObj.onload = function() {

					userImage = new fabric.Image(imgObj);
					userImage.set({
						left: 10,
						top: 10,
						width: canvas.width - 10,
						height: canvas.height - 10,
						opacity: 1
						// ,clipTo: function(ctx)
						// {
						// 	arrowPlane.set({
						// 		left: 50,
						// 		right: 50,
						// 		width: ctx.width,
						// 		length: ctx.length,
						// 	fill: 'red'
						// });
						//
						// arrowPlane.render(ctx);
						// }

						// ,clipTo: function(ctx) {
						// 	overlayState.set({
						// 		left: -100,
						// 		top: -100,
						// 		width: ctx.width,
						// 		height: ctx.height
						// 	});
						// 	// canvas.centerObject(overlayState);
						// 	overlayState.render(ctx);
						// }
					});
					canvas.add(userImage);
					userImage.globalCompositeOperation = 'source-atop';
					canvas.renderAll();
				}
			}
			reader.readAsDataURL(e.target.files[0]);
		}

		function testPath() {
			document.getElementById("statePath").innerHTML = statePath;
		}
	</script>


</body>

</html>
