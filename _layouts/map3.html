<!DOCTYPE html>
<html class="no-js">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Editor</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">

	<link rel="stylesheet" href="css/editor.css">
	<link rel="stylesheet" href="css/ui-lightness-jquery-ui-1.8.7.custom.css">

</head>

<body>

	<div id="imageEditor">
		<section id="editorContainer">
			<canvas id="editor" width="480" height="480" style="border:1px solid #000000"></canvas>
		</section>

	</div>

	<input type="file" id="UploadImage" href="#" title="Upload Your Image">Upload Image</input>

	<script src="jquery/jquery-1.12.4.min.js"></script>
	<script src="jquery/jquery-ui-1.10.3.js"></script>
	<script src="js/raphael.js"></script>
	<script src="js/usa_map.js"></script>
	<script src="js/Fabric_JS/fabric.min.js"></script>


	<script>
		//Changing the control colors from light blue to black
		fabric.Object.prototype.set({
			transparentCorners: true,
			borderColor: '#111111',
			cornerColor: '#111111'
		});

		//get information about the state that the user clicked on the main map page
		var stateNameStored = localStorage.getItem('storedStateName');
		var idNameStored = localStorage.getItem('storedIdName');

		// changing the editor background color
		var canvas = new fabric.Canvas('editor', {
			backgroundColor: 'white'
		});

		// loading the background/overlay image from SVG of the state that was cicked
		var statePath;
		var groupStates = [];
		var overlayState;
		fabric.loadSVGFromURL("svg/usa_map.svg", function(objects, options) {
				var stateObjects = new fabric.Group(groupStates);
				stateObjects.set({
					left: 10,
					top: 10,
					width: canvas.width - 10,
					height: canvas.height - 10
				});


				for (var i = 0; i < objects.length; i++) {
					if (stateObjects._objects[i].id == idNameStored) {
						overlayState = stateObjects._objects[i];

						overlayState.set({
							opacity: .4,
							left: 0,
							top: 0,
							// fill: 'white',
							// height: canvas.height,
							// width: canvas.width
							height: 250,
							width: 300, // Changed the size of the state so that it fits better in the canvas. This ties with the scaling X and Y
							selectable: false,
							scaleX: 1.5,
							scaleY: 1.5 // Increasing the size of the state image so it is easier for the user to fit their image into the shape of the state.\
						})

						// canvas.add(overlayState);
						// canvas.setOverlayImage(overlayState);
						// canvas.controlsAboveOverlay = true;
						statePath = String(stateObjects._objects[i].path); // hoping this will work for clip-path
						statePathObj = new fabric.Path(statePath);
						statePathObj.set({fill: 'red'});
						canvas.add(statePathObj);

					}
				}
			},
			function(item, object) {
				object.set('id', item.getAttribute('id'));
				groupStates.push(object);
			});


			// // uploading user image
			// var userImage = new fabric.Image();
			// document.getElementById('UploadImage').onchange = function handleImage(e) {
			//
			// 			var reader = new FileReader();
			// 			reader.onload = function(event) {
			//
			// 				var imgObj = new Image();
			// 				imgObj.src = event.target.result;
			// 				imgObj.onload = function() {
			//
			// 					userImage = new fabric.Image(imgObj);
			// 					userImage.set({
			// 						left: 10,
			// 						top: 10,
			// 						width: canvas.width - 10,
			// 						height: canvas.height - 10,
			// 						opacity: 1,
			// 						clipTo: function (ctx) {
			// 							overlayState.set ({
			// 								// left: 10,
			// 								// top: 10,
			// 								// width: canvas.width - 10,
			// 								// height: canvas.height - 10
			// 							});
			// 						 overlayState.render(ctx);
			// 					 }
			// 					});
			// 					canvas.add(userImage);
			// 					userImage.globalCompositeOperation = 'source-atop';
			// 					canvas.renderAll();
			// 				}
			// 			}
			// 			reader.readAsDataURL(e.target.files[0]);
			// 	}


			// uploading user image2
			var userImage = new fabric.Image();
			document.getElementById('UploadImage').onchange = function handleImage(e) {

						var reader = new FileReader();
						reader.onload = function(event) {

							var imgObj = new Image();
							imgObj.src = event.target.result;
							imgObj.onload = function() {

								userImage = new fabric.Image(imgObj);
								userImage.set({
									left: 10,
									top: 10,
									width: canvas.width - 10,
									height: canvas.height - 10,
									opacity: 1,
									clipTo: function (ctx) {
										overlayState.set ({
											left: -100,
											 top: -100,
											width: ctx.width,
											height: ctx.height
										});
										// canvas.centerObject(overlayState);
									 overlayState.render(ctx);

								 }
								});
								canvas.add(userImage);
								userImage.globalCompositeOperation = 'source-atop';
								canvas.renderAll();
							}
						}
						reader.readAsDataURL(e.target.files[0]);
				}
	</script>


</body>

</html>
