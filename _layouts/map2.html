<!DOCTYPE html>
<html class="no-js">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Editor</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">

	<link rel="stylesheet" href="css/editor.css">
	<link rel="stylesheet" href="css/ui-lightness-jquery-ui-1.8.7.custom.css">

</head>

<body>
	<p>Image Editor</p>

	<p id="clickedText"></p>

	<div id="imageEditor">
		<section id="editorContainer">
			<canvas id="editor" width="480" height="480" style="border:1px solid #000000">
										<img src="img/ota_badge.jpg" id="user-image"></img> <!-- This would be the image that the user loads and can be manipulated -->
										<img src="img/kentucky_outline.jpg" id="overlay"></img> <!-- This would be the state image which be used as the background image/ stensil -->
								</canvas>
		</section>

		<section id="toolbar">
			<a id="save" href="#" title="Save">Save</a>
			<!-- <a id="greyscale" href="#" title="Convert to grayscale">B&W</a>
								<a id="sepia" href="#" title="Convert to sepia tone">Sepia</a> -->
			<a id="ReCenter" href="#" title="Re-Center Your Image">Re-Center</a>
			<!-- Need to write a function to bring the user image back to the starting point -->
			<a id="clicked" href="#" title="What State was chosen?">Clicked State</a>
			<!-- used for testing -->
		</section>
	</div>
	<input type="file" id="UploadImage" href="#" title="Upload Your Image">Upload Image</input>
	<!-- Need to write a function which will allow the user to upload their image-->

	<script src="jquery/jquery-1.12.4.min.js"></script>
	<script src="jquery/jquery-ui-1.10.3.js"></script>
	<script src="js/usa_map.js"></script>
	<script src="js/Fabric_JS/fabric.min.js"></script>


	<script>
		//get canvas and context
		var stateNameStored = localStorage.getItem('storedStateName');
		var idNameStored = localStorage.getItem('storedIdName');

		var canvas = new fabric.Canvas('editor', {
			backgroundColor: 'white'
		});

		var overlay_img = document.getElementById('overlay'); // overlay image would be the state that they had chosen
		var overlayState = new fabric.Image(overlay_img, {
			opacity: .5,
			left: 0,
			top: 0,
			height: canvas.height,
			width: canvas.width
		});

		canvas.controlsAboveOverlay = true;
		canvas.setOverlayImage(overlayState); // overlay the image of the state that the user selected

		//commenting this out while working on image uploader

		// var imgElement = document.getElementById('user-image'); // This is the image that the user wants to fit into the state. We will need to build a way to upload images
		// var imgInstance = new fabric.Image(imgElement, {
		// 		left: 0,
		// 		top: 0,
		// 		height: canvas.height - 10,
		// 		width: canvas.width - 10,
		// 		opacity: 1
		// 	});

		// canvas.add(imgInstance);

		(function($) {
			// 	toolbar functions
			var tools = {

				//output to <img>
				save: function() {
					var saveDialog = $("<div>").appendTo("body");
					$("<img/>", {
						src: canvas.toDataURL()
					}).appendTo(saveDialog);
					saveDialog.dialog({
						resizable: false,
						modal: true,
						title: "Right-click and choose 'Save Image As'",
						width: canvas.width + 50,
						height: canvas.height + 50
					});
				},

				// 		greyscale: function() {
				// 				//get image data
				// 				var imgData = context.getImageData(0, 0, editor.width, editor.height),
				// 						pxData = imgData.data,
				// 						length = pxData.length;
				// 				for(var x = 0; x < length; x+=4) {
				// 						//convert to grayscale
				// 						var r = pxData[x],
				// 								g = pxData[x + 1],
				// 								b = pxData[x + 2],
				// 								grey = r * .3 + g * .59 + b * .11;
				// 						pxData[x] = grey;
				// 						pxData[x + 1] = grey;
				// 						pxData[x + 2] = grey;
				// 				}
				// 				//paint grayscale image back
				// 				context.putImageData(imgData, 0, 0);
				// 		},
				//
				// 		sepia: function() {
				// 		//get image data
				// 		var imgData = context.getImageData(0, 0, editor.width, editor.height),
				// 				pxData = imgData.data,
				// 				length = pxData.length;
				// 				for(var x = 0; x < length; x+=4) {
				// 						//convert to grayscale
				// 						var r = pxData[x],
				// 								g = pxData[x + 1],
				// 								b = pxData[x + 2],
				// 						sepiaR = r * .393 + g * .769 + b * .189,
				// 						sepiaG = r * .349 + g * .686 + b * .168,
				// 						sepiaB = r * .272 + g * .534 + b * .131;
				// 						pxData[x] = sepiaR;
				// 						pxData[x + 1] = sepiaG;
				// 						pxData[x + 2] = sepiaB;
				// 				}
				//
				// 				//paint sepia image back
				// 				context.putImageData(imgData, 0, 0);
				// 		},
				//
				//checking that the clicked state from the USA MAP page is coming over to the editor page

				ReCenter: function() {
					// imgInstance.set({
					userImage.set({
						left: 0,
						top: 0,
						height: canvas.height - 10,
						width: canvas.width - 10,
					});

				},


				// The below function is used for testing
				clicked: function() {
					//populating variables from what was clicked on the USA map
					document.getElementById("clickedText").innerHTML = "On the map, you clicked " + stateNameStored + " and " + idNameStored;
				}
			};

			$("#toolbar").children().click(function(e) {
				e.preventDefault();
				//call the relevant function
				tools[this.id].call(this);
			});

		})(jQuery);

		// Function for the upload image button
		document.getElementById('UploadImage').onchange = function handleImage(e) {
			var reader = new FileReader();
			reader.onload = function(event) {
				console.log('fdsf');

				var imgObj = new Image();
				imgObj.src = event.target.result;
				imgObj.onload = function() {
					var userImage = new fabric.Image(imgObj);
					userImage.set({
						left: 0,
						top: 0,
						// angle: 20,
						// padding: 10,
						// cornersize: 10
					});
					canvas.add(userImage);
				}
			}
			reader.readAsDataURL(e.target.files[0]);
		}
	</script>


</body>

</html>
